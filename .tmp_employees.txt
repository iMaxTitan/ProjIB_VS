'use client';

import React, { useState } from 'react';
import { Users, Plus, ChevronDown, ChevronRight, GripVertical } from 'lucide-react';
import { UserInfo } from '@/types/azure';
import { SupabaseUserInfo } from '@/types/supabase';
import { cn } from '@/lib/utils';
import { useIsMobile } from '@/hooks/useMediaQuery';
import { useEmployees } from '@/hooks/useEmployees';
import { BottomDrawer } from '@/components/ui/BottomDrawer';
import { Button } from '@/components/ui/Button';
import EmployeeCard from '@/components/employees/EmployeeCard';
import EmployeeDetails from '@/components/employees/EmployeeDetails';
import EmployeeFormModal from '@/components/employees/EmployeeFormModal';

interface EmployeesReferenceContentProps {
  user: UserInfo;
}

export default function EmployeesReferenceContent({ user }: EmployeesReferenceContentProps) {
  const [selectedEmployee, setSelectedEmployee] = useState<SupabaseUserInfo | null>(null);
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [panelWidth, setPanelWidth] = useState(480);
  const isResizingRef = React.useRef(false);
  const panelRef = React.useRef<HTMLDivElement>(null);

  const isMobile = useIsMobile();

  const {
    loading,
    error,
    employeesByDepartment,
    departments,
    filteredEmployees,
    expandedDepartments,
    toggleDepartment,
    handleEmployeeUpserted,
  } = useEmployees();

  const canEdit = user.role === 'chief' || user.role === 'head';

  const handleSelectEmployee = (employee: SupabaseUserInfo) => {
    setSelectedEmployee(employee);
    if (isMobile) {
      setIsDrawerOpen(true);
    }
  };

  const handleCloseDetails = () => {
    setSelectedEmployee(null);
    setIsDrawerOpen(false);
  };

  const handleEmployeeSaved = (employee: SupabaseUserInfo) => {
    handleEmployeeUpserted(employee);
    if (selectedEmployee?.user_id === employee.user_id) {
      setSelectedEmployee(employee);
    }
  };

  const handleMouseDown = () => {
    isResizingRef.current = true;
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  };

  const handleMouseMove = (e: MouseEvent) => {
    if (!isResizingRef.current) return;
    const newWidth = e.clientX - (panelRef.current?.getBoundingClientRect().left || 0);
    if (newWidth >= 280 && newWidth <= 600) {
      setPanelWidth(newWidth);
    }
  };

  const handleMouseUp = () => {
    isResizingRef.current = false;
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
  };

  const leftPanel = (
    <div className="flex flex-col h-full">
      <div className="flex-shrink-0 p-3 sm:p-4 border-b border-gray-100 bg-white/50">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Users className="h-5 w-5 text-emerald-600" aria-hidden="true" />
            <h2 className="text-base sm:text-lg font-bold text-slate-800">РЎРѕС‚СЂСѓРґРЅРёРєРё</h2>
            <span className="text-sm text-slate-400">({filteredEmployees.length})</span>
          </div>
          {canEdit && (
            <Button
              variant="default"
              size="sm"
              onClick={() => setShowAddModal(true)}
              aria-label="Р”РѕР±Р°РІРёС‚СЊ СЃРѕС‚СЂСѓРґРЅРёРєР°"
              className="gap-1.5 bg-emerald-600 hover:bg-emerald-700"
            >
              <Plus aria-hidden="true" className="h-4 w-4" />
              <span className="hidden sm:inline">Р”РѕР±Р°РІРёС‚СЊ</span>
            </Button>
          )}
        </div>
      </div>

      <div className="flex-1 overflow-y-auto overscroll-contain p-2 sm:p-3 space-y-2">
        {loading ? (
          <div className="flex justify-center py-12">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500" />
          </div>
        ) : error ? (
          <div className="text-center py-12 text-red-500">
            <p className="text-sm">{error}</p>
          </div>
        ) : departments.length === 0 ? (
          <div className="text-center py-12 text-slate-400">
            <Users className="h-12 w-12 mx-auto mb-3 opacity-50" aria-hidden="true" />
            <p className="text-sm">РЎРѕС‚СЂСѓРґРЅРёРєРё РЅРµ РЅР°Р№РґРµРЅС‹</p>
          </div>
        ) : (
          departments.map((department) => {
            const deptEmployees = employeesByDepartment[department] || [];
            const isExpanded = expandedDepartments[department] ?? true;

            return (
              <div key={department} className="space-y-1">
                <button
                  type="button"
                  onClick={() => toggleDepartment(department)}
                  aria-expanded={!!isExpanded}
                  aria-label={`${isExpanded ? 'РЎРІРµСЂРЅСѓС‚СЊ' : 'Р Р°Р·РІРµСЂРЅСѓС‚СЊ'} РѕС‚РґРµР» ${department}`}
                  className={cn(
                    'w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left',
                    'bg-gradient-to-r from-slate-100/80 to-slate-50/80 border border-slate-200/50',
                    'hover:from-slate-200/80 hover:to-slate-100/80',
                    'focus:outline-none focus:ring-2 focus:ring-emerald-500',
                    'transition-all'
                  )}
                >
                  {isExpanded ? (
                    <ChevronDown className="h-4 w-4 text-slate-400 flex-shrink-0" aria-hidden="true" />
                  ) : (
                    <ChevronRight className="h-4 w-4 text-slate-400 flex-shrink-0" aria-hidden="true" />
                  )}
                  <span className="text-sm font-semibold text-slate-700 flex-1 truncate">
                    {department}
                  </span>
                  <span className="text-xs text-slate-400 bg-white/60 px-2 py-0.5 rounded-full">
                    {deptEmployees.length}
                  </span>
                </button>

                {isExpanded && (
                  <div className="space-y-1 pl-2">
                    {deptEmployees.map((employee) => (
                      <EmployeeCard
                        key={employee.user_id}
                        employee={employee}
                        isSelected={selectedEmployee?.user_id === employee.user_id}
                        onClick={() => handleSelectEmployee(employee)}
                      />
                    ))}
                  </div>
                )}
              </div>
            );
          })
        )}
      </div>
    </div>
  );

  const rightPanel = selectedEmployee ? (
    <EmployeeDetails
      employee={selectedEmployee}
      currentUser={user}
      onClose={handleCloseDetails}
      onSave={handleEmployeeSaved}
      canEdit={canEdit}
    />
  ) : (
    <div className="flex flex-col items-center justify-center h-full text-slate-400 p-8">
      <Users className="h-16 w-16 mb-4 opacity-30" aria-hidden="true" />
      <p className="text-lg font-medium mb-2">Р’С‹Р±РµСЂРёС‚Рµ СЃРѕС‚СЂСѓРґРЅРёРєР°</p>
      <p className="text-sm text-center">
        РљР»РёРєРЅРёС‚Рµ РЅР° СЃРѕС‚СЂСѓРґРЅРёРєР° РІ СЃРїРёСЃРєРµ СЃР»РµРІР° РґР»СЏ РїСЂРѕСЃРјРѕС‚СЂР° РїРѕРґСЂРѕР±РЅРѕР№ РёРЅС„РѕСЂРјР°С†РёРё
      </p>
    </div>
  );

  if (isMobile) {
    return (
      <>
        <div className="flex flex-col h-full">
          <div className="flex-1 overflow-y-auto glass-panel">
            {leftPanel}
          </div>

          <BottomDrawer
            isOpen={isDrawerOpen}
            onClose={handleCloseDetails}
            height="full"
            showCloseButton={false}
            showDragHandle={false}
          >
            <div className="min-h-full p-3 pb-6">
              {rightPanel}
            </div>
          </BottomDrawer>
        </div>

        {showAddModal && (
          <EmployeeFormModal
            currentUser={user}
            onClose={() => setShowAddModal(false)}
            onEmployeeUpserted={handleEmployeeSaved}
          />
        )}
      </>
    );
  }

  return (
    <>
      <div className="flex h-full">
        <div
          ref={panelRef}
          className="glass-panel flex flex-col relative z-10 overflow-hidden bg-white/80"
          style={{ width: panelWidth }}
        >
          {leftPanel}

          <div
            className="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-emerald-300/50 active:bg-emerald-400/50 transition-colors group"
            onMouseDown={handleMouseDown}
            aria-label="РР·РјРµРЅРёС‚СЊ С€РёСЂРёРЅСѓ РїР°РЅРµР»Рё"
            role="separator"
            aria-orientation="vertical"
          >
            <div className="absolute right-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
              <GripVertical className="h-6 w-6 text-gray-400/50" aria-hidden="true" />
            </div>
          </div>
        </div>

        <div
          className={cn(
            'flex-1 overflow-y-auto overscroll-contain relative z-0',
            selectedEmployee ? 'bg-emerald-50/30' : 'bg-transparent'
          )}
        >
          {rightPanel}
        </div>
      </div>

      {showAddModal && (
        <EmployeeFormModal
          currentUser={user}
          onClose={() => setShowAddModal(false)}
          onEmployeeUpserted={handleEmployeeSaved}
        />
      )}
    </>
  );
}

