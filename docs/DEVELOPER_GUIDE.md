# ReportIB - Система управления планами ИБ

> **Дата актуализации**: 2026-02-03

## Проект
Система для подразделения информационной безопасности крупного ритейлера.
Управление годовыми/квартальными/месячными планами, задачами, KPI и отчетами.

## Критические правила

### 1. Идентификаторы пользователей
- ВСЕГДА использовать только Supabase `user_id` (UUID)
- НИКОГДА не использовать Azure AD ID для бизнес-логики
- Email - только для поиска/связи с Azure AD

### 2. Работа с данными
- Только через Supabase Views: `v_annual_plans`, `v_quarterly_plans`, `v_monthly_plans`, `v_user_details`
- Мутации данных - через RPC или сервисные функции в `src/lib/plans/plan-service.ts`
- departmentId всегда приводить к строке

### 3. Аутентификация
- Двойная система: Azure AD (корпоративная) + Supabase (профили)
- Используется redirect-авторизация (loginRedirect)
- Пользователь должен существовать в ОБЕИХ системах
- Кэширование: пользователь 5 мин (localStorage), Graph токены 30 мин
- Единственный файл конфигурации: `src/lib/auth/config.ts`
- **ВАЖНО:** Страницы получают user через `useAuth()` хук, НЕ через прямой вызов `getCurrentUser()`
- **ВАЖНО:** Сервисные функции принимают `userRole`/`userDepartmentId` как параметры, НЕ запрашивают из БД
- Подробнее: [modules/auth/authentication.md](modules/auth/authentication.md)

### 4. Структура кода
- UI-компоненты: `src/components/` (без бизнес-логики)
- Логика: `src/lib/` и `src/services/`
- Типы: `src/types/`
- Страницы: `src/app/` (App Router)

## Команды
- **Запуск (HTTPS)**: `npm run dev:https` — ОБЯЗАТЕЛЬНО для Azure AD авторизации!
- Запуск (HTTP): `npm run dev` — только для тестов без авторизации
- Сборка: `npm run build`
- Проверка типов: `npx tsc --noEmit`

**ВАЖНО**: Azure AD требует HTTPS. Проект доступен по адресу: https://maxtitan.me:3000

---

## Иерархия планов (АКТУАЛЬНО!)

Система использует **месячное планирование** (не недельное!):

```
┌─────────────────────────────────────────────────────────────────┐
│                     ГОДОВОЙ ПЛАН                                 │
│  Стратегическая цель подразделения на год                       │
│  Цвет: AMBER (янтарный)                                         │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 1:N (опционально)
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                   КВАРТАЛЬНЫЙ ПЛАН                               │
│  Тактическая цель на квартал                                    │
│  Связь: department_id, process_id                               │
│  Цвет: PURPLE (фиолетовый)                                      │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 1:N (опционально)
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    МЕСЯЧНЫЙ ПЛАН                                 │
│  ≡ Услуга (service_id) + Год + Месяц                            │
│  Исполнители (monthly_plan_assignees)                           │
│  Предприятия (monthly_plan_companies)                           │
│  Цвет: INDIGO (индиго)                                          │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 1:N (обязательно)
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ЕЖЕДНЕВНАЯ ЗАДАЧА                              │
│  Факт выполненной работы                                        │
│  task_date, spent_hours, description                            │
└─────────────────────────────────────────────────────────────────┘
```

**Связи опциональные (кроме задач):**
- Квартальный план БЕЗ привязки к годовому — срочные/незапланированные работы
- Месячный план БЕЗ привязки к квартальному — оперативные задачи
- Задача ВСЕГДА привязана к месячному плану

---

## Удаление планов

### Правила удаления
1. **Удалить может только создатель** плана (`user_id` / `created_by`)
2. **Иерархия обязательна**: чтобы удалить родительский план, сначала удалите дочерние
3. **Каскадное удаление**: при удалении месячного плана автоматически удаляются:
   - Все связанные задачи (`daily_tasks`)
   - Назначения исполнителей (`monthly_plan_assignees`)
   - Связи с компаниями (`monthly_plan_companies`)

### Функции удаления (plan-service.ts)

```typescript
// Проверка возможности удаления
canDeleteAnnualPlan(annualId, userId): Promise<DeleteCheckResult>
canDeleteQuarterlyPlan(quarterlyId, userId): Promise<DeleteCheckResult>
canDeleteMonthlyPlan(monthlyPlanId, userId): Promise<DeleteCheckResult>

// Удаление
deleteAnnualPlan(annualId, userId): Promise<{ success, error? }>
deleteQuarterlyPlan(quarterlyId, userId): Promise<{ success, error? }>
deleteMonthlyPlan(monthlyPlanId, userId): Promise<{ success, error?, deletedTasks? }>

interface DeleteCheckResult {
  canDelete: boolean;
  reason?: string;      // Причина, если нельзя удалить
  childCount?: number;  // Количество дочерних элементов
}
```

### UI удаления
- Кнопка 🗑️ в шапке карточки плана (`PlanDetailHeader`)
- Неактивна, если удаление невозможно (tooltip с причиной)
- При клике — подтверждение "Удалить?" с ✓/✗

---

## Модули системы

1. **Авторизация** (`src/lib/auth/`) - Azure AD + Supabase
2. **Планы** (`src/lib/plans/`) - годовые/квартальные/месячные
3. **Задачи** (`src/lib/tasks/`) - привязка к месячным планам
4. **Сотрудники** (`src/components/employees/`) - управление профилями
5. **KPI** (`src/components/dashboard/kpi/`) - показатели эффективности
6. **Компании** (`src/components/dashboard/companies/`) - партнеры
7. **Отчеты** (`src/lib/reports/`) - формирование отчетов

---

## База данных (Supabase)

> **Полная документация**: [docs/database/SCHEMA.md](database/SCHEMA.md)

### Ключевые таблицы

| Таблица | Описание |
|---------|----------|
| `user_profiles` | Профили (связь с Azure AD по email) |
| `annual_plans` | Годовые планы |
| `quarterly_plans` | Квартальные планы |
| `monthly_plans` | Месячные планы (NEW!) |
| `daily_tasks` | Ежедневные задачи (NEW!) |
| `services` | Справочник услуг |
| `departments`, `processes` | Справочники |
| `companies` | Компании-партнеры |

### Связующие таблицы

| Таблица | Связь |
|---------|-------|
| `monthly_plan_assignees` | Месячный план ↔ Исполнители |
| `monthly_plan_companies` | Месячный план ↔ Компании |

### Views (только чтение)
- `v_user_details` - детали пользователя
- `v_annual_plans`, `v_quarterly_plans`, `v_monthly_plans` - планы с агрегацией
- `v_kpi_current` - текущие значения KPI

---

## Роли пользователей

### Chief (Шеф) — стратегический руководитель
- НЕ создаёт планы
- Утверждает/отклоняет ВСЕ планы (годовые, квартальные, месячные)
- Видит ВСЁ: все отделы, все планы, audit log

### Head (Начальник отдела) — тактический руководитель
- Создаёт планы СВОЕГО отдела (годовые, квартальные, месячные)
- Отправляет на утверждение Chief
- Подтверждает задачи сотрудников
- Чужие отделы — только чтение

### Employee (Сотрудник) — исполнитель
- НЕ создаёт планы
- Создаёт задачи в назначенных АКТИВНЫХ месячных планах
- Видит только свои задачи и планы

---

## Навигация и интерфейс

### Горизонтальные вкладки (notebook-style)

**Главная навигация дашборда:**
- Горизонтальные вкладки в стиле блокнота (notebook tabs)
- Вкладки с закруглёнными углами сверху (`rounded-t-lg`)
- Активная вкладка: белый фон, тень, перекрывает нижнюю границу
- Всё работает на одном URL `/dashboard` — без переходов

**Порядок вкладок:**
```
Chief:    Активность → Планы → Задачи → Отчеты → KPI → Сотрудники → Предприятия
Head:     Активность → Планы → Задачи → Отчеты → KPI → Сотрудники
Employee: Активность → Планы → Задачи → Отчеты → KPI
```

### Вкладки планов (PlansPageNew)

| Уровень | Цвет вкладки | Градиент карточки |
|---------|--------------|-------------------|
| Годы | amber | `from-amber-500 to-orange-500` |
| Кварталы | purple | `from-purple-500 to-violet-500` |
| **Месяцы** | **indigo** | `from-indigo-500 to-blue-500` |

**Индикаторы времени:** зелёный (текущий), серый (прошлый), синий (будущий)

### Ключевые файлы

| Файл | Назначение |
|------|------------|
| `src/components/navigation/HorizontalNav.tsx` | Главная навигация |
| `src/app/dashboard/page.tsx` | Контейнер дашборда |
| `src/components/plans/PlansPageNew.tsx` | Страница планов |
| `src/components/plans/details/MonthlyPlanDetails.tsx` | Детали месячного плана |
| `src/components/plans/details/components/PlanDetailCommon.tsx` | Общие компоненты (header, delete) |
| `src/components/dashboard/Tasks/new/PlanListSidebar.tsx` | Список планов в задачах |

---

## Семантическая палитра (Кодирование цветом)

| Сущность | Цвет | Tailwind |
|----------|------|----------|
| Годовой план | **Amber** | `bg-amber-50`, `text-amber-900` |
| Квартальный план | **Purple** | `bg-purple-50`, `text-purple-900` |
| Месячный план | **Indigo** | `bg-indigo-50`, `text-indigo-900` |
| Процесс | **Slate** | `bg-slate-50`, `text-slate-900` |

**Статусы:**
- Выполнено: **Emerald** (изумрудный)
- В работе: **Violet** (фиолетовый)
- Просрочено/Ошибка: **Red** (красный)
- На рассмотрении: **Blue** (синий)
- Возвращен: **Amber** (янтарный)

---

## Типовые ошибки и решения

### План не создается
- Проверить, что передается корректный Supabase `user_id`
- НЕ использовать Azure AD ID

### План не удаляется
- Проверить, что вы создатель плана
- Удалить сначала дочерние планы (месячные → квартальные → годовые)

### Не отображается автор плана
- View должен возвращать `author_name`, `author_email`
- Компонент должен их отображать

### Задача не привязывается к плану
- Проверить связь `monthly_plan_id`
- Проверить `user_id` исполнителя

### Ошибка при обновлении профиля
- Использовать только RPC `upsert_user_profile`
- Email нельзя менять после создания

---

## Документация

| Документ | Описание |
|----------|----------|
| [BUSINESS_REQUIREMENTS.md](BUSINESS_REQUIREMENTS.md) | Бизнес-ТЗ ⭐ |
| [architecture/README.md](architecture/README.md) | Общая архитектура |
| [architecture/MONTHLY_PLANS.md](architecture/MONTHLY_PLANS.md) | Месячные планы |
| [database/SCHEMA.md](database/SCHEMA.md) | Схема БД |
| [modules/auth/authentication.md](modules/auth/authentication.md) | Аутентификация |
| [UI_DESIGN_SYSTEM.md](UI_DESIGN_SYSTEM.md) | Система дизайна |
