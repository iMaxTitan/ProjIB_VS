# üîë –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ReportIB

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

- **–ù–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ:** –î–≤–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å Azure AD –∏ Supabase
- **–î–∞—Ç–∞/–≤–µ—Ä—Å–∏—è:** 2025-05-26 / v1.0
- **–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ / AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
- **–ó–æ–Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è (–º–æ–¥—É–ª—å/—Ñ–∞–π–ª):** `src/lib/auth/`, `src/components/auth/`
- **–°—É—Ç—å —Ä–µ—à–µ–Ω–∏—è (—á—Ç–æ –∏ –∑–∞—á–µ–º):**
  –í –ø—Ä–æ–µ–∫—Ç–µ ReportIB —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–≤–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Azure AD (Microsoft Identity Platform) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ Supabase –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–∞–∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç–∞–∫ –∏ –≥–∏–±–∫–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
- **–ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è (–ø–æ—á–µ–º—É —Ç–∞–∫):**
  Azure AD –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, SSO –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏. Supabase –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ä–æ–ª–∏, –æ—Ç–¥–µ–ª—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏), –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≥–∏–±–∫–æ–π –º–æ–¥–µ–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–µ–∑ —É—Å–ª–æ–∂–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Azure AD.
- **–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é/Context7:** Context7: Microsoft Identity Platform, Supabase Auth
- **–î–∞—Ç–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è/–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏:** 2025-05-26

---

## üì¶ –ó–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: Azure AD Auth

- **–ú–æ–¥—É–ª—å/—Ñ–∞–π–ª:** `src/lib/auth/index.ts`, `src/lib/auth/config.ts`
- **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Microsoft Identity Platform
- **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MSAL
- **–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ Azure AD
- **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `LoginForm.tsx`, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö —Å –∑–∞—â–∏—â–µ–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º, –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Supabase Auth
- **–í–∞–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** @azure/msal-browser, Next.js
- **Best practice/—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã:**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ popup-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (loginPopup) - –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ localStorage
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
  - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ / AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

---

## üì¶ –ó–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: Supabase Auth

- **–ú–æ–¥—É–ª—å/—Ñ–∞–π–ª:** `src/lib/auth/index.ts` (—Ñ—É–Ω–∫—Ü–∏—è `getCurrentUser`)
- **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
- **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Azure AD
- **–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—å—é, –æ—Ç–¥–µ–ª–æ–º –∏ –¥—Ä—É–≥–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase –∫–ª–∏–µ–Ω—Ç, –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Azure AD Auth
- **–í–∞–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Supabase –∫–ª–∏–µ–Ω—Ç, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_user_details`
- **Best practice/—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã:**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ email –∫–∞–∫ –∫–ª—é—á–∞ —Å–≤—è–∑–∏ –º–µ–∂–¥—É Azure AD –∏ Supabase
  - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ / AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

---

## üì¶ –ó–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: Graph API

- **–ú–æ–¥—É–ª—å/—Ñ–∞–π–ª:** `src/lib/auth/graph.ts`
- **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è Microsoft Graph API
- **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ MSAL)
- **–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Graph API
- **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å Microsoft Graph
- **–í–∞–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** @azure/msal-browser, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞
- **Best practice/—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã:**
  - –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–∞–º—è—Ç—å + localStorage)
  - TTL –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ (30 –º–∏–Ω—É—Ç)
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
- **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ / AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

---

## üîÑ –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```mermaid
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Azure AD    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ MSAL Auth ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Supabase Auth ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ                   ‚îÇ
       ‚ñº                   ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ID-—Ç–æ–∫–µ–Ω    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ User Info ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π   ‚îÇ
‚îÇ  Access-—Ç–æ–∫–µ–Ω‚îÇ     ‚îÇ           ‚îÇ     ‚îÇ –ø—Ä–æ—Ñ–∏–ª—å       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üõ†Ô∏è –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. MSAL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```typescript
// src/lib/auth/config.ts
export const getMsalConfig = () => ({
  auth: {
    clientId: '977d0ffb-a361-4b37-aa47-48814355345f', // ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Azure AD
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin,
    postLogoutRedirectUri: window.location.origin,
    navigateToLoginRequestUrl: true
  },
  cache: {
    cacheLocation: 'localStorage',
    storeAuthStateInCookie: true
  },
  system: {
    loggerOptions: {
      loggerCallback: (level, message, containsPii) => {
        if (!containsPii) console.log(`MSAL [${level}]: ${message}`);
      },
      logLevel: 3 // Verbose when needed
    }
  }
});
```

### 2. –•—É–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```typescript
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ö—É–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
const { 
  user,                // –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ null
  isLoading,           // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
  error,               // –û–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ null
  isAuthenticated,     // –§–ª–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  authErrorType,       // –¢–∏–ø –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  login,               // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Ö–æ–¥–∞
  logout,              // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—Ö–æ–¥–∞
  getToken,            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
  refreshToken         // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
} = useAuth();
```

### 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ**: TTL 5 –º–∏–Ω—É—Ç
- **Graph API —Ç–æ–∫–µ–Ω—ã**: TTL 30 –º–∏–Ω—É—Ç
- **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ**: –ø–∞–º—è—Ç—å + localStorage

## üë• –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### `AzureUserInfo` (–±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ Azure AD)

```typescript
interface AzureUserInfo {
  id: string;             // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Azure AD
  email: string;          // –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞
  name: string;           // –ü–æ–ª–Ω–æ–µ –∏–º—è
  displayName: string;    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
  accessToken: string;    // –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞
}
```

### `UserInfo` (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å –¥–∞–Ω–Ω—ã–º–∏ Supabase)

```typescript
interface UserInfo extends AzureUserInfo {
  user_id: string;          // ID –≤ Supabase (PRIMARY KEY)
  role: UserRole;           // –†–æ–ª—å (chief, head, employee)
  role_disp: string;        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏
  department_id: string;    // ID –æ—Ç–¥–µ–ª–∞
  department_name: string;  // –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞
  status: UserStatus;       // –°—Ç–∞—Ç—É—Å (active, blocked –∏ —Ç.–¥.)
}
```

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- **`interaction_required`**: –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **`supabase_user_not_found`**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ Azure AD, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ Supabase
- **`other`**: –ü—Ä–æ—á–∏–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üîç –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ –≤ Supabase**: –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º email —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Supabase
2. **Unified Single Source of Truth**: –ü–æ–ª–µ `user.user_id` (ID –∏–∑ Supabase) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –¥–∞–Ω–Ω—ã–º–∏
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 2.5 –º–∏–Ω—É—Ç—ã –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. **Popup-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è loginPopup —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

---

## üîê –ü—Ä–æ—Ü–µ—Å—Å –≤—Ö–æ–¥–∞ (Login)

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```typescript
// –í—ã–∑–æ–≤ –∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
const { login } = useAuth();
await login();
```

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π

1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `msal.loginPopup()` —Å –∑–∞–ø—Ä–æ—Å–æ–º scopes
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è popup-–æ–∫–Ω–æ Microsoft –¥–ª—è –≤–≤–æ–¥–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ popup –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
4. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `getCurrentUser()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ Supabase
5. –î–∞–Ω–Ω—ã–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ localStorage (TTL 5 –º–∏–Ω—É—Ç)
6. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è cookie `auth_status=true`

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **Popup-–æ–∫–Ω–æ**: –ù–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç redirect)
- **–û—Ç–º–µ–Ω–∞ –≤—Ö–æ–¥–∞**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∫—ç—à–∞

---

## üö™ –ü—Ä–æ—Ü–µ—Å—Å –≤—ã—Ö–æ–¥–∞ (Logout)

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```typescript
// src/lib/auth/index.ts
export const logout = async (): Promise<void> => {
  // 1. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  localStorage.removeItem(USER_CACHE_KEY);
  localStorage.removeItem(USER_CACHE_EXPIRY_KEY);
  localStorage.removeItem('graph_api_token');
  localStorage.removeItem('graph_api_token_expiry');

  // 2. –£–¥–∞–ª–µ–Ω–∏–µ cookie –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  setAuthStatusCookie(false);

  // 3. –õ–æ–∫–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ MSAL (–±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ Microsoft)
  const msal = await initializeMsal();
  const account = msal.getActiveAccount();

  if (account) {
    await msal.logout({
      account: account,
      onRedirectNavigate: () => false // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
    });
  }

  msal.setActiveAccount(null);
};
```

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π

1. –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
2. –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à —Ç–æ–∫–µ–Ω–æ–≤ Graph API
3. –£–¥–∞–ª—è–µ—Ç—Å—è cookie `auth_status`
4. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `msal.logout()` —Å `onRedirectNavigate: () => false`
5. MSAL –æ—á–∏—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
6. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç

### –í–∞–∂–Ω–æ: –õ–æ–∫–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ vs –ü–æ–ª–Ω—ã–π –≤—ã—Ö–æ–¥

| –ê—Å–ø–µ–∫—Ç | –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ª–æ–∫–∞–ª—å–Ω—ã–π) | –ü–æ–ª–Ω—ã–π –≤—ã—Ö–æ–¥ (redirect) |
|--------|-------------------------------|------------------------|
| –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–æ–Ω | –ù–µ—Ç | –î–∞ (–æ–∫–Ω–æ Microsoft) |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è | –ù–µ—Ç | –î–∞ |
| –°–µ—Å—Å–∏—è Microsoft | –û—Å—Ç–∞–µ—Ç—Å—è | –ó–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ | –ë—ã—Å—Ç—Ä—ã–π (SSO) | –¢—Ä–µ–±—É–µ—Ç –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è |

–í—ã–±—Ä–∞–Ω **–ª–æ–∫–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥** –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å Microsoft.

---

## üìã –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

> **–î–∞—Ç–∞**: 2026-02-07. –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î.

### –ü—Ä–∞–≤–∏–ª–æ 1: –°—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–∞—é—Ç user –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ `useAuth()`

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –æ–¥–∏–Ω —Ö—É–∫, –¥–∞–Ω–Ω—ã–µ –∏–∑ –µ–¥–∏–Ω–æ–≥–æ –∫—ç—à–∞
export default function MyPage() {
  const { user, isLoading } = useAuth();
  if (isLoading) return <Spinner />;
  if (!user) { redirect('/login'); return null; }
  return <MyContent user={user} />;
}

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞ –∏ –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –∫ v_user_details
export default function MyPage() {
  const [user, setUser] = useState(null);
  useEffect(() => { getCurrentUser().then(setUser); }, []);
  // ...
}
```

**–ü–æ—á–µ–º—É:** `useAuth()` —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `getCurrentUser()` –≤–Ω—É—Ç—Ä–∏, –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ React state –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞–∂–¥—ã–µ 2.5 –º–∏–Ω. –í—ã–∑–æ–≤ `getCurrentUser()` –Ω–∞–ø—Ä—è–º—É—é —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

### –ü—Ä–∞–≤–∏–ª–æ 2: –°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç role/department –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ user, –ø–µ—Ä–µ–¥–∞—ë–º –Ω–∞–ø—Ä—è–º—É—é
export async function getActivityStats(
  userId: string,
  userRole: string,              // –∏–∑ user.role
  userDepartmentId: string|null, // –∏–∑ user.department_id
  departmentId?: string,
  daysBack = 7
)

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ user_profiles
export async function getActivityStats(userId: string, ...) {
  const { data } = await supabase.from('user_profiles')
    .select('role, department_id').eq('user_id', userId).single();
}
```

**–ü–æ—á–µ–º—É:** –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É–∂–µ –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–π `UserInfo` –æ–±—ä–µ–∫—Ç —Å role –∏ department_id. –ü–µ—Ä–µ–¥–∞—á–∞ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —ç–∫–æ–Ω–æ–º–∏—Ç 1 –∑–∞–ø—Ä–æ—Å –∫ –ë–î –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤.

### –ü—Ä–∞–≤–∏–ª–æ 3: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç user —á–µ—Ä–µ–∑ props –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã

```
–°—Ç—Ä–∞–Ω–∏—Ü–∞ (useAuth ‚Üí user)
  ‚îî‚îÄ DashboardContent (user prop)
      ‚îú‚îÄ ActivityContent (user prop) ‚Üí getActivityFeed(user.user_id, user.role, user.department_id, ...)
      ‚îú‚îÄ PlansPageNew (user prop)
      ‚îî‚îÄ EmployeesContent (user prop)
```

**–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å** –æ—Ç–¥–µ–ª—å–Ω—ã–π UserContext ‚Äî `useAuth()` + –ø—Ä–æ–±—Ä–æ—Å props —É–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏.

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç)

| –°–ª–æ–π | –ì–¥–µ | TTL | –ß—Ç–æ –∫—ç—à–∏—Ä—É–µ—Ç |
|------|-----|-----|-------------|
| localStorage | `auth_user_cache` | 5 –º–∏–Ω | –ü–æ–ª–Ω—ã–π UserInfo (role, dept, name...) |
| React state | `useAuth().user` | –¥–æ unmount | –¢–æ –∂–µ, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 2.5 –º–∏–Ω |
| Supabase view | `v_user_details` | - | JOIN user_profiles + departments |

**–ü–æ—Ç–æ–∫:** `useAuth()` ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç localStorage –∫—ç—à ‚Üí –µ—Å–ª–∏ –∏—Å—Ç—ë–∫, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `v_user_details` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç user.

### –§–∞–π–ª—ã

| –§–∞–π–ª | –†–æ–ª—å |
|------|------|
| `src/lib/auth/index.ts` | `getCurrentUser()`, `useAuth()`, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ |
| `src/app/dashboard/page.tsx` | –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `useAuth()` |
| `src/app/dashboard/plans/page.tsx` | –ü–ª–∞–Ω—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `useAuth()` |
| `src/lib/services/activity.service.ts` | –ü—Ä–∏–Ω–∏–º–∞–µ—Ç userRole/userDepartmentId –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã |

---

## üöÄ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è

1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Teams SSO –¥–ª—è –±–µ—Å—à–æ–≤–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Teams-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ MFA —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Microsoft
