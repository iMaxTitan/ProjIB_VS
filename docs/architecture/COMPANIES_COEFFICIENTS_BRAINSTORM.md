# Предприятия и коэффициенты: брейншторм

> Дата: 2026-02-02
> Статус: Обсуждение

## 1. Текущая структура предприятий

### 1.1. Таблица companies

```
┌─────────────────────────────────────────────┐
│              COMPANIES                       │
├─────────────────────────────────────────────┤
│ АТБ Маркет         (основное)               │
│ АТБ Енерго                                   │
│ Корпорація АТБ                               │
│ КФ Квітень                                   │
│ Логістік Юніон                               │
│ МФ Фаворит                                   │
│ Рітейл Девелопмент                           │
│ ЧП Транс Логистик                            │
└─────────────────────────────────────────────┘
```

### 1.2. Ежемесячная инфраструктура (company_infrastructure)

| Поле | Описание |
|------|----------|
| period_year | Год записи |
| period_month | Месяц записи |
| servers_count | Количество серверов |
| workstations_count | Количество рабочих станций |

### 1.3. Текущие рассчитываемые проценты

View `v_companies_with_infrastructure` уже считает:

```sql
workstations_percentage = (company.workstations / total_workstations) * 100
servers_percentage = (company.servers / total_servers) * 100
```

**Пример (февраль 2026):**

| Предприятие | ПК | % ПК | Серверы | % Серверов |
|-------------|-----|------|---------|------------|
| АТБ Маркет | 5000 | 60% | 120 | 50% |
| АТБ Енерго | 1500 | 18% | 40 | 17% |
| Корпорація АТБ | 800 | 10% | 50 | 21% |
| Інші | 1000 | 12% | 30 | 12% |

---

## 2. Вопросы для обсуждения

### 2.1. Что такое "коэффициент" в контексте планирования?

**Варианты:**

1. **Коэффициент трудоёмкости услуги для предприятия**
   - Услуга "Антивірусний захист" для АТБ Маркет требует 60% часов (пропорционально ПК)

2. **Коэффициент сложности предприятия**
   - Базовый коэффициент = 1.0
   - АТБ Маркет = 1.5 (сложнее)
   - Маленькие компании = 0.5

3. **Коэффициент для конкретной услуги на предприятии**
   - Матрица: Услуга × Предприятие = Коэффициент

### 2.2. Как коэффициент влияет на плановые часы?

```
Пример расчёта:

Услуга: "Оновлення ПЗ серверів"
Базовые часы на 1 сервер: 0.5 часа/месяц

АТБ Маркет: 120 серверов × 0.5 = 60 часов
АТБ Енерго: 40 серверов × 0.5 = 20 часов
Корпорація АТБ: 50 серверов × 0.5 = 25 часов
```

---

## 3. Варианты архитектуры коэффициентов

### Вариант A: Коэффициенты на основе инфраструктуры

Используем существующие данные `company_infrastructure`.

```
┌─────────────────────────────────────────────────────────┐
│                      SERVICES                            │
│  + hours_per_workstation (часов на 1 ПК)                │
│  + hours_per_server (часов на 1 сервер)                 │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              Расчёт плановых часов:                     │
│                                                          │
│  Для каждого предприятия в monthly_plan_companies:      │
│  planned_hours = servers × hours_per_server             │
│                + workstations × hours_per_workstation   │
└─────────────────────────────────────────────────────────┘
```

**Плюсы:**
- Автоматический расчёт
- Привязка к реальной инфраструктуре
- Не нужна отдельная таблица коэффициентов

**Минусы:**
- Не все услуги зависят от инфраструктуры
- Слишком механистический подход

---

### Вариант B: Таблица коэффициентов (service_company_coefficients)

```sql
CREATE TABLE service_company_coefficients (
  coefficient_id UUID PRIMARY KEY,
  service_id UUID REFERENCES services,
  company_id UUID REFERENCES companies,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,

  -- Варианты значений коэффициента:
  coefficient NUMERIC DEFAULT 1.0,       -- Множитель
  -- ИЛИ
  fixed_hours NUMERIC,                   -- Фиксированные часы
  -- ИЛИ
  percentage NUMERIC,                    -- Процент от общего

  notes TEXT,
  UNIQUE(service_id, company_id, year, month)
);
```

**Плюсы:**
- Полный контроль
- Можно задать любые значения
- Ежемесячное обновление

**Минусы:**
- Много ручной работы (8 компаний × N услуг × 12 месяцев)
- Нужен интерфейс для ввода

---

### Вариант C: Комбинированный подход

1. **Базовый расчёт** — из инфраструктуры
2. **Корректирующий коэффициент** — для особых случаев

```sql
-- В таблице services добавляем:
ALTER TABLE services ADD COLUMN
  calculation_type TEXT DEFAULT 'manual';
  -- 'manual' - ручной ввод часов
  -- 'by_servers' - на основе серверов
  -- 'by_workstations' - на основе ПК
  -- 'by_endpoints' - на основе суммы

ALTER TABLE services ADD COLUMN
  hours_per_unit NUMERIC DEFAULT 0;
  -- Часов на единицу (сервер/ПК)
```

---

## 4. Связь с месячными планами

### 4.1. Текущая схема

```
monthly_plans ←──── monthly_plan_companies ────► companies
     │
     ├── service_id (услуга)
     ├── planned_hours (общие часы)
     └── assignees (исполнители)
```

### 4.2. Куда добавить коэффициенты?

**Вариант 1: В monthly_plan_companies**

```sql
ALTER TABLE monthly_plan_companies ADD COLUMN
  planned_hours NUMERIC;  -- Плановые часы для этой компании
```

Позволяет распределить часы плана по компаниям.

**Вариант 2: Отдельная таблица распределения**

```sql
CREATE TABLE monthly_plan_company_hours (
  monthly_plan_id UUID,
  company_id UUID,
  planned_hours NUMERIC NOT NULL,
  actual_hours NUMERIC DEFAULT 0,  -- Сумма из daily_tasks
  coefficient NUMERIC DEFAULT 1.0,
  PRIMARY KEY (monthly_plan_id, company_id)
);
```

---

## 5. Сценарии использования

### 5.1. Создание месячного плана

1. Head выбирает услугу "Антивірусний захист"
2. Выбирает предприятия: АТБ Маркет, АТБ Енерго
3. Система показывает рекомендуемые часы на основе:
   - Инфраструктуры компаний
   - Коэффициентов услуги
4. Head корректирует при необходимости
5. Сохраняется план с распределением часов

### 5.2. Отчётность по компаниям

```
Февраль 2026
────────────────────────────────────
Услуга: Антивірусний захист

| Предприятие    | План | Факт | Коэф. |
|----------------|------|------|-------|
| АТБ Маркет     | 60ч  | 55ч  | 0.60  |
| АТБ Енерго     | 18ч  | 20ч  | 0.18  |
| Корпорація АТБ | 10ч  | 8ч   | 0.10  |
────────────────────────────────────
ИТОГО:           | 88ч  | 83ч  | 1.00  |
```

---

## 6. Вопросы к обсуждению

1. **Какие услуги зависят от инфраструктуры?**
   - Антивирус → от ПК
   - Бэкапы → от серверов
   - Обучение → от кол-ва пользователей?

2. **Нужен ли ручной ввод коэффициентов?**
   - Или достаточно авторасчёта из инфраструктуры?

3. **Как часто меняются коэффициенты?**
   - Раз в месяц (при обновлении инфраструктуры)?
   - Раз в квартал?
   - При необходимости?

4. **Отдельный интерфейс для коэффициентов?**
   - В разделе "Предприятия"?
   - В разделе "Услуги"?
   - Отдельная вкладка "Коэффициенты"?

5. **Как отображать в задаче привязку к компании?**
   - Задача = работа над конкретной компанией?
   - Или задача общая, а компания информативна?

---

## 7. Следующие шаги

- [ ] Определить список услуг и их типы расчёта
- [ ] Решить: таблица коэффициентов или расширение services
- [ ] Спроектировать UI для управления коэффициентами
- [ ] Реализовать расчёт рекомендуемых часов
- [ ] Обновить отчётность по компаниям
